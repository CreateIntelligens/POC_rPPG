#!/bin/sh
# =============================================================================
# Nginx 環境變數替換和啟動腳本
# 此腳本在 Nginx 容器啟動時執行，用於動態替換配置模板中的環境變數
# 然後啟動 Nginx 服務器
# =============================================================================

set -e  # 遇到錯誤立即退出

# 設定預設值 -------------------------------------------------------------------
# 如果環境變數未設定，使用預設端口
APP_PORT=${APP_PORT:-8894}          # FastAPI 應用端口
EXTERNAL_PORT=${EXTERNAL_PORT:-8894} # 外部訪問端口

# 輸出當前配置 -----------------------------------------------------------------
echo "🔧 配置 Nginx 環境變數替換..."
echo "   APP_PORT: $APP_PORT"
echo "   EXTERNAL_PORT: $EXTERNAL_PORT"

# 執行環境變數替換 -------------------------------------------------------------
# 使用 envsubst 將模板文件中的變數替換為實際值
echo "📝 替換配置文件模板..."
envsubst '${APP_PORT} ${EXTERNAL_PORT}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf

# 驗證配置 ---------------------------------------------------------------------
if [ ! -f /etc/nginx/conf.d/default.conf ]; then
    echo "❌ 配置檔案生成失敗"
    exit 1
fi

echo "✅ Nginx 配置檔案已生成"

# 啟動 Nginx -------------------------------------------------------------------
echo "🚀 啟動 Nginx 服務器..."
exec nginx -g 'daemon off;'  # 前台運行 Nginx（適用於 Docker）
